# New microservices version of the system
#

version: '3.2'

services:
    db:
        image: postgres:10.1-alpine
        restart: always
        environment:
            POSTGRES_PASSWORD: example
        volumes:
            - pgdata_alpine:/var/lib/postgresql/data
        ports:
            - 5433:5432

    posda:
        image: quasarj/posda2:latest
        restart: always
        depends_on:
            - db
        ports:
            - 64610-64699:64610-64699
        volumes:
            - posda_cache_alpine:/home/posda/cache
            - ./posda/posdatools:/home/posda/posdatools
            - /mnt:/mnt
        environment:
            TZ: America/Chicago
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example
            POSDA_EXTERNAL_HOSTNAME: localhost

    posda-file-process:
        image: quasarj/posda2:latest
        command: file-process
        restart: always
        depends_on:
            - db
        volumes:
            - posda_cache_alpine:/home/posda/cache
            - ./posda/posdatools:/home/posda/posdatools
        environment:
            TZ: America/Chicago
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example
            POSDA_EXTERNAL_HOSTNAME: localhost

    posda-api:
        image: quasarj/posda2:latest
        command: api
        restart: always
        depends_on:
            - db
            - posda
        environment:
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example

        volumes:
            - posda_cache_alpine:/home/posda/cache
            - ./posda/posda-api:/posda-api

    quince:
        image: quasarj/quince:latest
        restart: always
        depends_on:
            - db
            - posda
        volumes:
            - posda_cache_alpine:/home/posda/cache
            - quince_files:/html
        environment:
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example

    kaleidoscope:
        image: quasarj/kaleidoscope:latest
        restart: always
        depends_on:
            - db
            - posda
        volumes:
            - posda_cache_alpine:/home/posda/cache
            - kaleidoscope_files:/html
            - ./kaleidoscope/kaleidoscope:/app
        environment:
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example
            #DEBUG: 1

    k-base:
        image: quasarj/k-base:latest
        restart: always
        depends_on:
            - db
            - posda
        volumes:
            - posda_cache_alpine:/home/posda/cache
        environment:
            PGHOST: db
            PGUSER: postgres
            PGPASSWORD: example
        links:
            - quince:quince

    nginx:
        image: quasarj/posda_nginx:latest
        restart: always
        ports:
            - 80:80
        depends_on:
            - posda
            - quince
            - kaleidoscope
        links:
            - posda:posda
            - posda-api:posda-api
            - quince:quince
            - kaleidoscope:kaleidoscope
        volumes:
            - type: volume
              source: quince_files
              target: /quince
              volume:
                nocopy: true
            - type: volume
              source: kaleidoscope_files
              target: /kaleidoscope
              volume:
                nocopy: true

volumes:
    posda_cache_alpine:
    # posda_submission_root:
    pgdata_alpine:
    quince_files:
    kaleidoscope_files:


